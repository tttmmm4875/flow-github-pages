name: PR Preview Cleanup

# PRãŒã‚¯ãƒ­ãƒ¼ã‚ºã•ã‚ŒãŸæ™‚ã«ãƒˆãƒªã‚¬ãƒ¼
on:
  pull_request:
    types: [closed]
    branches: [main]

# å¿…è¦ãªæ¨©é™è¨­å®š
permissions:
  contents: write
  pull-requests: write

jobs:
  cleanup-preview:
    runs-on: ubuntu-latest
    
    steps:
      # ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # gh-pagesãƒ–ãƒ©ãƒ³ãƒã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout gh-pages branch
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          # gh-pagesãƒ–ãƒ©ãƒ³ãƒãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          if git show-ref --verify --quiet refs/remotes/origin/gh-pages; then
            git fetch origin gh-pages
            git checkout gh-pages
          else
            echo "gh-pages branch does not exist, nothing to cleanup"
            exit 0
          fi

      # PRç”¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å‰Šé™¤
      - name: Remove PR directory
        run: |
          PR_DIR="pr-${{ github.event.number }}"
          
          if [ -d "$PR_DIR" ]; then
            echo "Removing directory: $PR_DIR"
            rm -rf "$PR_DIR"
            
            # å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥
            git add .
            git commit -m "Cleanup PR #${{ github.event.number }} preview directory"
            git push origin gh-pages
            
            echo "cleanup_performed=true" >> $GITHUB_ENV
          else
            echo "Directory $PR_DIR does not exist, nothing to cleanup"
            echo "cleanup_performed=false" >> $GITHUB_ENV
          fi

      # ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†ã‚’PRã«ã‚³ãƒ¡ãƒ³ãƒˆ
      - name: Comment cleanup completion
        if: env.cleanup_performed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.issue.number;
            const cleanupMessage = [
              'ğŸ§¹ **ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã—ã¾ã—ãŸ**',
              '',
              `PR #${prNumber} ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒãŒæ­£å¸¸ã«å‰Šé™¤ã•ã‚Œã¾ã—ãŸã€‚`,
              'GitHub Pagesã‹ã‚‰è©²å½“ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒé™¤å»ã•ã‚Œã¦ã„ã¾ã™ã€‚'
            ].join('\n');
            
            github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: cleanupMessage
            })

      # ã‚¨ãƒ©ãƒ¼æ™‚ã®ã‚³ãƒ¡ãƒ³ãƒˆ
      - name: Comment on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âŒ **ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã«å¤±æ•—ã—ã¾ã—ãŸ**\n\nè©³ç´°ã¯GitHub Actionsã®ãƒ­ã‚°ã‚’ã”ç¢ºèªãã ã•ã„ã€‚'
            })
